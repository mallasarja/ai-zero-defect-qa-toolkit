# PR-IMPACT â€” IO-136500 (gptverse#682)

Changed areas (highlights)
- New security layer: query reformulation prompt `QUERY_SECURITY_REFORMULATION`
- Response parsing: suggestions delimiter handling; links/suggestions emission order
- Headers: expose `context_value`; include in non-stream and stream responses
- Standard vs context-aware prompts restructured (`STANDARD_KB_RESPONSE`, modified `GENERATE_CONTEXT_AWARE_RESPONSE`)
- Unit tests updated for streaming suggestions and thresholds

## Tests

- **Test Case ID:** PR-IO-136500-BE-001
- **Title/Description:** Response headers include `context_value` alongside `thread_id`
- **Preconditions:** Feature flag on; stream=false and stream=true
- **Test Steps:**
  - POST answer with context_value set; capture response (non-stream); verify headers
  - Repeat with stream=true; verify SSE headers
- **Test Data:** { query, url, context_aware:true, context_value:"Flow Builder", return_sources:true, stream:[false|true] }
- **Expected Result:** Headers expose `thread_id,context_value`; `context_value` equals request value or derived
- **Tags/Labels:** PR-IMPACT, API, Headers
- **Test Type:** API Contract
- **Diff Ref:** KnowledgeBaseResource: Access-Control-Expose-Headers + context_value

- **Test Case ID:** PR-IO-136500-BE-002
- **Title/Description:** Suggestions emitted using delimiter or parsed post-stream
- **Preconditions:** use_assistant=false
- **Test Steps:**
  - Send query to produce suggestions; read SSE stream; ensure delimiter `$$$$---SUGGESTIONS---$$$$` appears and suggestions JSON afterward
- **Test Data:** stream=true
- **Expected Result:** Suggestions delimiter present; JSON suggestions chunk follows; links emitted after
- **Tags/Labels:** PR-IMPACT, Stream
- **Test Type:** Recovery/Observability
- **Diff Ref:** _handle_context_aware_next_stream_response + _handle_links

- **Test Case ID:** PR-IO-136500-BE-003
- **Title/Description:** Standard (non-context) prompt path uses `STANDARD_KB_RESPONSE`
- **Preconditions:** context_aware=false
- **Test Steps:**
  - POST with context_aware=false; verify system/user templates used; ensure suggestions delimiter and answer format
- **Test Data:** stream=false
- **Expected Result:** Response structure follows standard prompt; no context tokens
- **Tags/Labels:** PR-IMPACT, Prompt
- **Test Type:** Functional
- **Diff Ref:** prompts.json STANDARD_KB_RESPONSE

- **Test Case ID:** PR-IO-136500-BE-004
- **Title/Description:** Query security reformulation engaged; logs annotation
- **Preconditions:** Security prompt enabled (default in code); logs accessible
- **Test Steps:**
  - POST with prompt-injection style query; verify reformulation occurs and logged (query_reformulated=true)
- **Test Data:** injection-like text
- **Expected Result:** Reformulated query differs; log contains original and reformulated
- **Tags/Labels:** PR-IMPACT, Security
- **Test Type:** Security
- **Diff Ref:** _apply_query_security + prompts.json QUERY_SECURITY_REFORMULATION

- **Test Case ID:** PR-IO-136500-BE-005
- **Title/Description:** Linked sources retrieval excludes main article IDs; summary conditional
- **Preconditions:** Pinecone mocked
- **Test Steps:**
  - Provide sources with linkedArticleIds including duplicates and main IDs; assert filter; summaries only when numTokens>threshold and flag enabled
- **Test Data:** mocked results
- **Expected Result:** No dupes; no main IDs; summaries as per rules
- **Tags/Labels:** PR-IMPACT, Data Integrity
- **Test Type:** Data Integrity
- **Diff Ref:** get_linked_sources refactor

- **Test Case ID:** PR-IO-136500-BE-006
- **Title/Description:** Non-stream response parsing pulls suggestions from body delimiter
- **Preconditions:** use_assistant=false
- **Test Steps:**
  - stream=false; send query that includes delimiter; verify parsing into answer + suggestions map
- **Test Data:** stream=false
- **Expected Result:** suggestions parsed; included in response JSON; `context_value` present
- **Tags/Labels:** PR-IMPACT, Parsing
- **Test Type:** Functional
- **Diff Ref:** _create_non_streaming_response + _parse_context_aware_response
